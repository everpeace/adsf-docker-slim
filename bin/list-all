#!/usr/bin/env bash

set \
  -o nounset \
  -o pipefail \
  -o errexit

readonly VER_REGEX='(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)'

function sort_versions() {
	sed 'h; s/[+-]/./g; s/.p\([[:digit:]]\)/.z\1/; s/$/.z/; G; s/\n/ /' |
		LC_ALL=C sort -t. -k 1,1 -k 2,2n -k 3,3n -k 4,4n -k 5,5n |
		awk '{print $2}'
}

list_versions() {
  git ls-remote --tags --refs https://github.com/docker-slim/docker-slim.git | grep -o 'refs/tags/.*' | cut -d/ -f3- | sed 's/^v//'
}

get_arch () {
  local arch=$(uname | tr '[:upper:]' '[:lower:]')

  if [ "${arch}" = "darwin" ]; then
    arch="mac"
  fi

  echo "${arch}"
}

get_filename () {
  local -r version="$1"
  local -r ext="$2"

  local -r arch="$(get_arch)"

  echo "${version}/dist_${arch}${ext}"
}

get_download_url () {
  local -r version="$1"
  local -r ext="${2:-.zip}"

  local -r filename="$(get_filename "${version}" "${ext}")"
  echo "https://github.com/docker-slim/docker-slim/releases/download/${filename}"
}

list_all () {
  echo "$(list_versions | sort_versions | tr '\n' ' ')"
}

list_all

